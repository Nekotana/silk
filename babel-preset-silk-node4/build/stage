#! /usr/bin/env node

/**
 * We programatically build the babel plugin list using babel-features.
 *
 * Currently this targets node 4 in the future we will update this to future LTS
 * node versions...
 */

'use strict';

const path = require('path');
const fs = require('fs');

const features = require('babel-features');

const TARGET = path.join(__dirname, '..');
const PKG_PATH = path.join(TARGET, 'package.json');
const DEST = path.join(TARGET, 'staging/index.js');

const DEFAULT_BABEL_VERSION = '6.5.0';
const PLUGIN_VERSION_OVERRIDES = {
  // 'transform-async-to-generator': 'MY_VER'
};

const PLUGIN_SKIP = new Set([
  'transform-es2015-generator-return'
]);

const ADDITIONAL_PLUGINS = [
  // flow ..
  'syntax-flow',
  'transform-flow-strip-types',
  // stage-3
  'transform-async-to-generator',
  // stage 2
  'transform-object-rest-spread',
  'syntax-trailing-function-commas',
  // stage-1
  'transform-class-constructor-call',
  'transform-class-properties',
  'transform-decorators',
  'transform-export-extensions',

  // XXX: v8 does not like you to use super.X syntax which is used in our
  // codebase so we compile our modules down using es2015.
  'transform-es2015-classes',
];

const es2015Plugins = features.options().plugins.filter((name) => {
  return !PLUGIN_SKIP.has(name);
});

const requiredPlugins = new Set(es2015Plugins.concat(ADDITIONAL_PLUGINS));

let pkg = require(PKG_PATH);

if (!pkg.devDependencies) {
  pkg.devDependencies = {};
}

let installedPlugins = [];

for (let plugin of requiredPlugins) {
  let babelName = `babel-plugin-${plugin}`;
  installedPlugins.push(`  require('${babelName}')`);
  let version = PLUGIN_VERSION_OVERRIDES[plugin] || DEFAULT_BABEL_VERSION;
  pkg.devDependencies[babelName] = version;
}

let indexTmpl = `
// Do not edit: this file is automatically generated...
module.exports = {
  plugins: [
    ${installedPlugins.join(', \n')}
  ]
};
`;

fs.writeFileSync(DEST, indexTmpl);
fs.writeFileSync(PKG_PATH, JSON.stringify(pkg, null, 2));
